<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>A/R Payment with Office Dropdown</title>
  <style>
    :root {
      --primary-bg: #f2f2f2;
      --primary-text: #000000;
      --card-bg: #ffffff;
      --input-bg: #ffffff;
      --input-text: #000000;
      --switch-bg-off: #ccc;
      --switch-bg-on: #007BFF;
      --button-bg: #007BFF;
      --button-bg-hover: #0056b3;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--primary-bg);
      color: var(--primary-text);
    }

    .container-wrapper {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 40px;
    }

    .container {
      width: 90%;
      max-width: 600px;
    }

    .card {
      background-color: var(--card-bg);
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
      overflow: hidden;
    }

    .card-content {
      padding: 20px;
    }

    .card-content h2 {
      margin-top: 0;
    }

    .form-row {
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
    }

    .form-row label {
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-row input[type="text"],
    .form-row select,
    .form-row input[type="file"] {
      padding: 8px;
      font-size: 14px;
      background-color: var(--input-bg);
      color: var(--input-text);
      border: 1px solid #ccc;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .button-row {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    button {
      cursor: pointer;
      padding: 10px 20px;
      background-color: var(--button-bg);
      color: #ffffff;
      border: none;
      border-radius: 4px;
      font-size: 14px;
    }

    button:hover {
      background-color: var(--button-bg-hover);
    }

    /* Toggle Switch Styles */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; 
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--switch-bg-off);
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: var(--switch-bg-on);
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }

    /* DARK MODE OVERRIDES */
    body.dark-mode {
      --primary-bg: #121212;
      --primary-text: #ffffff;
      --card-bg: #1e1e1e;
      --input-bg: #2c2c2c;
      --input-text: #ffffff;
      --switch-bg-off: #888;
      --switch-bg-on: #66aaff;
      --button-bg: #3b82f6;
      --button-bg-hover: #2563eb;
    }
  </style>
</head>
<body>
  <div class="container-wrapper">
    <div class="container">
      <div class="card">
        <div class="card-content">
          <h2>A/R Payment</h2>

          <!-- Dark Mode Toggle -->
          <div class="form-row toggle-row">
            <label class="switch">
              <input type="checkbox" id="darkModeSwitch">
              <span class="slider"></span>
            </label>
            <label for="darkModeSwitch" style="margin-bottom: 0;">Dark Mode?</label>
          </div>

          <!-- 1) Office Dropdown at the TOP (default Cobb) -->
          <div class="form-row">
            <label for="officeSelect">Office:</label>
            <select id="officeSelect">
              <option value="Cobb" selected>Cobb</option>
              <option value="Fulton">Fulton</option>
              <option value="Gwinnett">Gwinnett</option>
              <option value="DeKalb">DeKalb</option>
            </select>
          </div>

          <!-- County Selection (also defaults to Cobb) -->
          <div class="form-row">
            <label for="countySelect">Select County:</label>
            <select id="countySelect">
              <option value="Cobb" selected>Cobb</option>
              <option value="Fulton">Fulton</option>
              <option value="Gwinnett">Gwinnett</option>
              <option value="DeKalb">DeKalb</option>
            </select>
          </div>

          <!-- Employee Name -->
          <div class="form-row">
            <label for="employeeNameSelect">Employee Name:</label>
            <select id="employeeNameSelect">
              <option value="Lucas" selected>Lucas</option>
              <option value="John Doe">John Doe</option>
              <option value="Jane Smith">Jane Smith</option>
              <option value="Alice Johnson">Alice Johnson</option>
              <option value="Bob Williams">Bob Williams</option>
            </select>
          </div>

          <!-- Payment Amount -->
          <div class="form-row">
            <label for="paymentAmountInput">Payment Amount ($):</label>
            <input id="paymentAmountInput" type="text" placeholder="$0.00">
          </div>

          <!-- Toggle Switch for Partial Payment -->
          <div class="form-row toggle-row">
            <label class="switch">
              <input type="checkbox" id="partialPaymentSwitch">
              <span class="slider"></span>
            </label>
            <label for="partialPaymentSwitch" style="margin-bottom: 0;">Partial Payment?</label>
          </div>

          <!-- Actual Amount Agreed -->
          <div class="form-row" id="partialPaymentRow" style="display: none;">
            <label id="partialPaymentLabel" for="partialPaymentInput">Actual Amount Agreed:</label>
            <input id="partialPaymentInput" type="text" list="partialPaymentDataList" placeholder="$0.00">
            <datalist id="partialPaymentDataList">
              <!-- Populated in JS -->
            </datalist>
          </div>

          <!-- Multiple File Upload -->
          <div class="form-row">
            <label for="receiptUpload">Upload Signed Receipts (Multiple):</label>
            <input id="receiptUpload" type="file" accept="image/*" multiple>
          </div>

          <!-- Buttons -->
          <div class="button-row">
            <button id="saveBtn" type="button">Save</button>
            <button id="saveAndSendBtn" type="button">Save and Send</button>
            <button id="exportBtn" type="button">Export to Excel (CSV)</button>
            <button id="saveToPhpBtn" type="button">Save to PHP/MySQL</button>
          </div>
        </div> <!-- .card-content -->
      </div> <!-- .card -->
    </div> <!-- .container -->
  </div> <!-- .container-wrapper -->

  <script>
    // =============== References ===============
    const darkModeSwitch = document.getElementById("darkModeSwitch");
    const officeSelect = document.getElementById("officeSelect");
    const countySelect = document.getElementById("countySelect");
    const employeeNameSelect = document.getElementById("employeeNameSelect");
    const paymentAmountInput = document.getElementById("paymentAmountInput");

    const partialPaymentSwitch = document.getElementById("partialPaymentSwitch");
    const partialPaymentRow = document.getElementById("partialPaymentRow");
    const partialPaymentInput = document.getElementById("partialPaymentInput");
    const partialPaymentLabel = document.getElementById("partialPaymentLabel");
    const partialPaymentDataList = document.getElementById("partialPaymentDataList");

    const receiptUpload = document.getElementById("receiptUpload");

    const saveBtn = document.getElementById("saveBtn");
    const saveAndSendBtn = document.getElementById("saveAndSendBtn");
    const exportBtn = document.getElementById("exportBtn");
    const saveToPhpBtn = document.getElementById("saveToPhpBtn");  // new button

    // =============== Data List for partial payment up to 10,000 in increments of 25 ===============
    function populatePartialPaymentDataList() {
      for (let i = 25; i <= 10000; i += 25) {
        const optionElement = document.createElement("option");
        optionElement.value = i.toFixed(2);
        partialPaymentDataList.appendChild(optionElement);
      }
    }
    populatePartialPaymentDataList();

    // =============== Format currency on blur ===============
    function formatToUSD(inputElement) {
      let rawValue = inputElement.value.trim();
      if (!rawValue) {
        inputElement.value = "";
        return;
      }
      // Remove any non-digit or decimal chars (like $, commas)
      rawValue = rawValue.replace(/[^\d.]/g, "");
      const parsedValue = parseFloat(rawValue);
      if (!isNaN(parsedValue)) {
        inputElement.value = parsedValue.toLocaleString("en-US", {
          style: "currency",
          currency: "USD"
        });
      } else {
        inputElement.value = "";
      }
    }

    paymentAmountInput.addEventListener("blur", function() {
      formatToUSD(paymentAmountInput);
    });
    partialPaymentInput.addEventListener("blur", function() {
      formatToUSD(partialPaymentInput);
    });

    // Toggle partial payment row
    partialPaymentSwitch.addEventListener("change", function() {
      if (partialPaymentSwitch.checked) {
        partialPaymentRow.style.display = "block";
        partialPaymentLabel.textContent = "Actual Amount Agreed:";
      } else {
        partialPaymentRow.style.display = "none";
      }
    });

    // Parse currency from a string like "$1,234.56" to float 1234.56
    function parseCurrencyString(currencyString) {
      if (!currencyString) {
        return 0;
      }
      const numericString = currencyString.replace(/[^\d.]/g, "");
      const value = parseFloat(numericString);
      return isNaN(value) ? 0 : value;
    }

    // =============== Save Locally ===============
    function saveLocally() {
      const officeValue = officeSelect.value;
      const countyValue = countySelect.value;
      const employeeName = employeeNameSelect.value;
      const paymentAmount = parseCurrencyString(paymentAmountInput.value);

      let partialPaymentActive = false;
      let partialPaymentAmount = null;
      if (partialPaymentSwitch.checked) {
        partialPaymentActive = true;
        partialPaymentAmount = parseCurrencyString(partialPaymentInput.value);
      }

      const files = receiptUpload.files;
      let fileNamesArray = [];
      for (let i = 0; i < files.length; i++) {
        fileNamesArray.push(files[i].name);
      }

      const arPaymentData = {
        office: officeValue,
        county: countyValue,
        employeeName: employeeName,
        paymentAmount: paymentAmount,
        partialPayment: partialPaymentActive,
        partialPaymentAmount: partialPaymentAmount,
        receiptFileNames: fileNamesArray,
        timestamp: new Date().toISOString()
      };

      localStorage.setItem("arPayment", JSON.stringify(arPaymentData));
      alert("Payment data (including office) saved locally.");
    }

    // =============== Send Email ===============
    function sendEmail() {
      const subject = "A/R Payment Information";

      const officeValue = officeSelect.value;
      const countyValue = countySelect.value;
      const employeeName = employeeNameSelect.value;
      const paymentAmount = parseCurrencyString(paymentAmountInput.value);

      let partialPaymentText = "No";
      let partialPaymentDetail = "";
      if (partialPaymentSwitch.checked) {
        partialPaymentText = "Yes";
        const partialAmount = parseCurrencyString(partialPaymentInput.value);
        partialPaymentDetail = "\nActual Amount Agreed: $" + partialAmount.toFixed(2);
      }

      const files = receiptUpload.files;
      let multipleFileNames = "";
      if (files.length > 0) {
        multipleFileNames = "\nAttached File Names:";
        for (let i = 0; i < files.length; i++) {
          multipleFileNames += "\n - " + files[i].name;
        }
      }

      const body =
        "Office: " + officeValue +
        "\nCounty: " + countyValue +
        "\nEmployee: " + employeeName +
        "\nPayment Amount: $" + paymentAmount.toFixed(2) +
        "\nPartial Payment: " + partialPaymentText +
        partialPaymentDetail +
        multipleFileNames +
        "\n\n(This data also saved locally in the browser.)";

      const mailtoLink =
        "mailto:jamieflint@bondjamesbondinc.com,ar@bondjamesbondinc.com"
        + "?subject=" + encodeURIComponent(subject)
        + "&body=" + encodeURIComponent(body);

      window.open(mailtoLink, "_blank");
    }

    // =============== Export to CSV ===============
    function exportToCSV() {
      const savedData = localStorage.getItem("arPayment");
      if (!savedData) {
        alert("No payment data found in localStorage to export.");
        return;
      }

      const arPaymentData = JSON.parse(savedData);

      let joinedFileNames = "";
      if (Array.isArray(arPaymentData.receiptFileNames)) {
        joinedFileNames = arPaymentData.receiptFileNames.join(";");
      }

      const headers = [
        "Office",
        "County",
        "Employee Name",
        "Payment Amount",
        "Partial Payment?",
        "Actual Amount Agreed",
        "Receipt File Names",
        "Timestamp"
      ];

      const row = [
        arPaymentData.office,
        arPaymentData.county,
        arPaymentData.employeeName,
        arPaymentData.paymentAmount,
        arPaymentData.partialPayment ? "Yes" : "No",
        arPaymentData.partialPaymentAmount ? arPaymentData.partialPaymentAmount : "",
        joinedFileNames,
        arPaymentData.timestamp
      ];

      const csvContent = [
        headers.join(","),
        row.join(",")
      ].join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "ar_payment_data.csv");
      link.style.display = "none";

      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // =============== Save to PHP/MySQL ===============
    function saveToPHP() {
      // Gather data just like we do in saveLocally()
      const officeValue = officeSelect.value;
      const countyValue = countySelect.value;
      const employeeName = employeeNameSelect.value;
      const paymentAmount = parseCurrencyString(paymentAmountInput.value);

      let partialPaymentActive = false;
      let partialPaymentAmount = null;
      if (partialPaymentSwitch.checked) {
        partialPaymentActive = true;
        partialPaymentAmount = parseCurrencyString(partialPaymentInput.value);
      }

      const files = receiptUpload.files;
      let fileNamesArray = [];
      for (let i = 0; i < files.length; i++) {
        fileNamesArray.push(files[i].name);
      }

      // Build object to send to PHP
      const arPaymentData = {
        office: officeValue,
        county: countyValue,
        employeeName: employeeName,
        paymentAmount: paymentAmount,
        partialPayment: partialPaymentActive,
        partialPaymentAmount: partialPaymentAmount,
        receiptFileNames: fileNamesArray
      };

      // POST JSON to save_payment.php
      fetch("save_payment.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(arPaymentData)
      })
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            alert("Payment saved in MySQL! Payment ID: " + result.paymentId);
          } else {
            alert("Error saving payment: " + result.error);
          }
        })
        .catch(error => {
          console.error("Fetch error:", error);
          alert("Fetch error: " + error.message);
        });
    }

    // =============== Button handlers ===============
    saveBtn.addEventListener("click", function() {
      saveLocally();
    });

    saveAndSendBtn.addEventListener("click", function() {
      saveLocally();
      sendEmail();
    });

    exportBtn.addEventListener("click", function() {
      exportToCSV();
    });

    // new button that calls the PHP script
    saveToPhpBtn.addEventListener("click", function() {
      saveToPHP();
    });

    // Dark Mode
    darkModeSwitch.addEventListener("change", function() {
      document.body.classList.toggle("dark-mode", darkModeSwitch.checked);
    });
  </script>
</body>
</html>
