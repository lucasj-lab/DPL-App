<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>A/R Payment with Office Dropdown</title>
  <style>
:root {
  /* Light Mode Variables */
  --primary-bg: #f2f2f2;
  --primary-text: #000000;
  --card-bg: #ffffff;
  --input-bg: #ffffff;
  --input-text: #000000;
  --switch-bg-off: #ccc;
  --switch-bg-on: #007BFF;
  --button-bg: #007BFF;
  --button-bg-hover: #0056b3;
}

/* By default, we add "dark-mode" to body. 
   (You can also have JavaScript toggle it off if the user unchecks the switch.) */
body.dark-mode {
  --primary-bg: #121212;
  --primary-text: #ffffff;
  --card-bg: #1e1e1e;
  --input-bg: #2c2c2c;
  --input-text: #ffffff;
  --switch-bg-off: #888;
  --switch-bg-on: #66aaff;
  --button-bg: #3b82f6;
  --button-bg-hover: #2563eb;
}

body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  background-color: var(--primary-bg);
  color: var(--primary-text);
}

/* CONTAINER STYLES (unchanged) */
.container-wrapper {
  width: 100%;
  display: flex;
  justify-content: center;
  margin-top: 40px;
}
.container {
  width: 90%;
  max-width: 600px;
}
.card {
  background-color: var(--card-bg);
  border-radius: 4px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  margin-bottom: 20px;
  overflow: hidden;
}
.card-content {
  padding: 20px;
}
.card-content h2 {
  margin-top: 0;
}

/* FORM ROWS */
.form-row {
  margin-bottom: 15px;
  display: flex;
  flex-direction: column;
}
.form-row label {
  margin-bottom: 5px;
  font-weight: bold;
}

/* 1) Force all input/ select to 200px wide */
.form-row input[type="text"],
.form-row input[list],
.form-row select,
.form-row input[type="file"],
.split-row select,
.split-row input[type="text"] {

  padding: 8px;
  font-size: 14px;
  background-color: var(--input-bg);
  color: var(--input-text);
 
  border: 1px solid #ccc;
}
input#defendantNameInput {
  height: 30px;
  width: 80%;
}
/* TOGGLE ROWS */
.toggle-row {
  display: flex;
  gap: 10px;
}

/* BUTTONS */
.button-row {
  display: flex;
  gap: 10px;
  margin-top: 20px;
  flex-wrap: wrap;
}
button {
  cursor: pointer;
  padding: 10px 20px;
  background-color: var(--button-bg);
  color: #ffffff;
  border: none;
  border-radius: 4px;
  font-size: 14px;
}
button:hover {
  background-color: var(--button-bg-hover);
}

/* SWITCHES */
.switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
}
.switch input {
  position: absolute;
  top: 0;
  left: 0;
  width: 50px;
  height: 24px;
  opacity: 0.01; /* minimal so it can still receive focus */
  cursor: pointer;
}
.switch input:focus + .slider {
  outline: 2px dotted #333;
}
.slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: var(--switch-bg-off);
  transition: .4s;
  border-radius: 24px;
}
.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}
input:checked + .slider {
  background-color: var(--switch-bg-on);
}
input:checked + .slider:before {
  transform: translateX(26px);
}

/* 2) SPLIT PAYMENT CONTAINER */
.split-payment-container {
  border: 1px solid #ccc;
  background-color: var(--input-bg);
  padding: 10px;
  margin-top: 10px;
  margin-bottom: 10px;

}
.split-row {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}

/* 3) "Configure" Toggle for Office/Account/Employee fields */
.configure-section {
  display: none; /* hide by default */
  margin-top: 10px;
}
/* If #configureToggle is checked, show the configure section */
#configureToggle:checked ~ .configure-section {
  display: block;
}

  </style>
</head>
<body class="dark-mode">  <!-- Force dark mode at load -->

  <div class="container-wrapper">
    <div class="container">
      <div class="card">
        <div class="card-content">

          <!-- 1) Dark Mode Switch (checked by default) -->
          <div class="form-row toggle-row">
            <label class="switch">
              <input type="checkbox" id="darkModeSwitch" checked>
              <span class="slider"></span>
            </label>
            <label for="darkModeSwitch" style="margin-bottom: 0;">Dark Mode?</label>
          </div>

          <!-- 2) "Configure" Toggle -->
          <div class="form-row toggle-row">
            <label class="switch">
              <input type="checkbox" id="configureToggle">
              <span class="slider"></span>
            </label>
            <label for="configureToggle" style="margin-bottom: 0;">Configure?</label>
          </div>

   <!-- Office Dropdown -->
   <div class="configure-section">
   <div class="form-row">
    <label for="officeSelect">Office:</label>
    <select id="officeSelect">
      <option value="Cobb" selected>Cobb</option>
      <option value="12732">Barrow</option>
      <option value="12733">Bartow</option>
      <option value="12734">Carroll</option>
      <option value="12735">Cherokee</option>
      <option value="12736">Clarke</option>
      <option value="12738">Floyd</option>
      <option value="12739">Gordon</option>
      <option value="12740">Gwinnett</option>
      <option value="12741">Haralson</option>
      <option value="12742">Paulding</option>
      <option value="14385">Pickens</option>
      <option value="12743">Polk</option>
    </select>
  </div>

  <!-- County Selection (Account) -->

  <div class="form-row">
    <label for="countySelect">Account:</label>
    <select id="countySelect">
      <option value="Cobb" selected>Cobb</option>
      <option value="12732">Barrow</option>
      <option value="12733">Bartow</option>
      <option value="12734">Carroll</option>
      <option value="12735">Cherokee</option>
      <option value="12736">Clarke</option>
      <option value="12738">Floyd</option>
      <option value="12739">Gordon</option>
      <option value="12740">Gwinnett</option>
      <option value="12741">Haralson</option>
      <option value="12742">Paulding</option>
      <option value="14385">Pickens</option>
      <option value="12743">Polk</option>
    </select>
  </div>

  <!-- Employee Name -->
  <div class="form-row">
    <label for="employeeNameInput">Employee Name:</label>
    <input id="employeeNameInput" list="employeeNameSelect" placeholder="Choose Employee..." value="Lucas">
    <datalist id="employeeNameSelect">
      <option value="Lucas"></option>
      <option value="Adam P."></option>
      <option value="Amber M."></option>
      <!-- Add more employees as needed -->
      <option value="Vicki W."></option>
    </datalist>
  </div>

          <!-- Date Input Only (Defendant Name now in first row below) -->
          <div class="form-row" style="flex-direction: row; gap: 20px;">
            <div style="flex: 1;">
              <label for="paymentDateInput">Date:</label><br>
              <input id="paymentDateInput" type="text" placeholder="MM/DD/YYYY">
            </div>
          </div>
        </div>
          <div class="split-payment-container" id="splitPaymentContainer">
            <p style="margin-top:0; font-weight:bold;">Payment Details:</p>
          
            <!-- Defendant Name on its own, above the row of Payment Type & Amount -->
            <div class="split-row" id="firstPaymentRow">
              <label for="defendantNameInput"></label><br>
              <input id="defendantNameInput" type="text" placeholder="Defendant Name" role="textbox">
            </div>
          
            <!-- FIRST/DEFAULT PAYMENT ROW: Payment Type & Amount side by side -->
            <div class="split-row" id="firstPaymentRow">
              <div>
                <label for="firstPaymentTypeSelect"></label><br>
                <select id="firstPaymentTypeSelect" placeholder="Payment Type" role="combobox">
                  <option value="Cash">Cash</option>
                  <option value="Check">Check</option>
                  <option value="Money Order">Money Order</option>
                  <option value="Credit Card">Credit Card</option>
                </select>
              </div>
              <div>
                <label for="firstPaymentAmountInput"></label><br>
                <input id="firstPaymentAmountInput" type="text" placeholder="Payment Amount ($)" role="textbox">
              </div>
            </div>
          
            <!-- Additional split rows appended here (Payment Type + Amount + Remove) -->
            <div id="splitRows"></div>
          
            <!-- Button to add more rows -->
            <button type="button" id="addSplitRowButton" style="margin-top:5px;">+ Add Payment Method</button>
          </div>
          <!-- Toggle Switch for Partial Payment -->
          <div class="form-row toggle-row">
            <label class="switch">
              <input type="checkbox" id="partialPaymentSwitch">
              <span class="slider"></span>
            </label>
            <label for="partialPaymentSwitch" style="margin-bottom: 0;">Partial Payment?</label>
          </div>

          <!-- Actual Amount Due (shown only if partial switch is ON) -->
          <div class="form-row" id="partialPaymentRow" style="display: none;">
            <label id="partialPaymentLabel" for="partialPaymentInput">Actual Amount Due:</label>
            <input id="partialPaymentInput" type="text" list="partialPaymentDataList" placeholder="$0.00">
            <datalist id="partialPaymentDataList">
              <!-- Populated in JS (increments of $25) -->
            </datalist>
          </div>

       
          <!-- (Hidden) Receipt Upload to avoid JS error if not present -->
          <div style="display:none;">
            <label for="receiptUpload">Receipt Upload:</label>
            <input type="file" id="receiptUpload" multiple />
          </div>

          <!-- Buttons -->
          <div class="button-row">
            <!-- VISIBLE Button #1: Save -->
            <button id="saveBtn" type="button">Save</button>

            <!-- VISIBLE Button #2: Save and Send -->
            <button id="saveAndSendBtn" type="button">Save and Send</button>

            <!-- HIDDEN Extra Buttons (CSV, XLS, XLSX, Save to PHP) -->
            <button id="exportBtn" type="button" style="display:none;">Export to Excel (CSV)</button>
            <button id="saveToPhpBtn" type="button" style="display:none;">Save to PHP/MySQL</button>
            <button id="exportXlsBtn" type="button" style="display:none;">Export to XLS</button>
            <button id="exportXlsxBtn" type="button" style="display:none;">Export to XLSX</button>
          </div>
        </div> <!-- .card-content -->
      </div> <!-- .card -->
    </div> <!-- .container -->
  </div> <!-- .container-wrapper -->

  <!-- 1) Load SheetJS for XLSX export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <script>
    // =============== DARK MODE / BASIC REFERENCES ===============
    const darkModeSwitch = document.getElementById("darkModeSwitch");
    const officeSelect = document.getElementById("officeSelect");
    const countySelect = document.getElementById("countySelect");
    const employeeNameInput = document.getElementById("employeeNameInput");
    const paymentDateInput = document.getElementById("paymentDateInput");
    const receiptUpload = document.getElementById("receiptUpload");

    const partialPaymentSwitch = document.getElementById("partialPaymentSwitch");
    const partialPaymentRow = document.getElementById("partialPaymentRow");
    const partialPaymentInput = document.getElementById("partialPaymentInput");
    const partialPaymentLabel = document.getElementById("partialPaymentLabel");
    const partialPaymentDataList = document.getElementById("partialPaymentDataList");

    // Buttons
    const saveBtn = document.getElementById("saveBtn");
    const saveAndSendBtn = document.getElementById("saveAndSendBtn");
    const exportBtn = document.getElementById("exportBtn");
    const saveToPhpBtn = document.getElementById("saveToPhpBtn");
    const exportXlsBtn = document.getElementById("exportXlsBtn");
    const exportXlsxBtn = document.getElementById("exportXlsxBtn");

    // Split Payment Elements
    const splitPaymentContainer = document.getElementById("splitPaymentContainer");
    const firstPaymentTypeSelect = document.getElementById("firstPaymentTypeSelect");
    const firstPaymentAmountInput = document.getElementById("firstPaymentAmountInput");
    const defendantNameInput = document.getElementById("defendantNameInput");
    const addSplitRowButton = document.getElementById("addSplitRowButton");
    const splitRowsContainer = document.getElementById("splitRows");

    // =============== DARK MODE HANDLER ===============
    darkModeSwitch.addEventListener("change", function() {
      document.body.classList.toggle("dark-mode", darkModeSwitch.checked);
    });

    // =============== AUTO-SET DATE IN MM/DD/YYYY ===============
    window.addEventListener("load", function() {
      const today = new Date();
      const yyyy = today.getFullYear();
      let mm = (today.getMonth() + 1).toString().padStart(2, "0");
      let dd = today.getDate().toString().padStart(2, "0");
      paymentDateInput.value = `${mm}/${dd}/${yyyy}`;
    });

    // =============== PARTIAL PAYMENT DROPDOWN (increments of 25) ===============
    function populatePartialPaymentDataList() {
      for (let i = 25; i <= 10000; i += 25) {
        const optionElement = document.createElement("option");
        optionElement.value = i.toFixed(2);
        partialPaymentDataList.appendChild(optionElement);
      }
    }
    populatePartialPaymentDataList();

    // =============== SHOW/HIDE PARTIAL PAYMENT INPUT ===============
    partialPaymentSwitch.addEventListener("change", function() {
      if (partialPaymentSwitch.checked) {
        partialPaymentRow.style.display = "block";
        partialPaymentLabel.textContent = "Actual Amount Due:";
      } else {
        partialPaymentRow.style.display = "none";
      }
    });

    // =============== FORMAT TO USD ===============
    function formatToUSD(inputElement) {
      let rawValue = inputElement.value.trim();
      if (!rawValue) {
        inputElement.value = "";
        return;
      }
      rawValue = rawValue.replace(/[^\d.]/g, "");
      const parsedValue = parseFloat(rawValue);
      if (!isNaN(parsedValue)) {
        inputElement.value = parsedValue.toLocaleString("en-US", {
          style: "currency",
          currency: "USD"
        });
      } else {
        inputElement.value = "";
      }
    }

    // Attach blur format to first rowâ€™s amount
    firstPaymentAmountInput.addEventListener("blur", function() {
      formatToUSD(firstPaymentAmountInput);
    });
    partialPaymentInput.addEventListener("blur", function() {
      formatToUSD(partialPaymentInput);
    });

    // =============== PARSE CURRENCY STRING => number ===============
    function parseCurrencyString(currencyString) {
      if (!currencyString) {
        return 0;
      }
      const numericString = currencyString.replace(/[^\d.]/g, "");
      const value = parseFloat(numericString);
      return isNaN(value) ? 0 : value;
    }

    // =============== ADDITIONAL SPLIT ROWS ===============
    const paymentTypes = ["Cash", "Check", "Money Order", "Credit Card"];

    addSplitRowButton.addEventListener("click", function() {
      addSplitRow();
    });

    function addSplitRow() {
      const rowDiv = document.createElement("div");
      rowDiv.classList.add("split-row");

      // Payment type
      const selectEl = document.createElement("select");
      paymentTypes.forEach(function(pt) {
        const opt = document.createElement("option");
        opt.value = pt;
        opt.textContent = pt;
        selectEl.appendChild(opt);
      });

      // Amount input
      const amountInput = document.createElement("input");
      amountInput.type = "text";
      amountInput.placeholder = "Payment Amount ($)";
      amountInput.addEventListener("blur", function() {
        formatToUSD(amountInput);
      });

      // Remove button
      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.textContent = "Remove";
      removeBtn.style.backgroundColor = "#d9534f";
      removeBtn.addEventListener("click", function() {
        rowDiv.remove();
      });

      rowDiv.appendChild(selectEl);
      rowDiv.appendChild(amountInput);
      rowDiv.appendChild(removeBtn);
      splitRowsContainer.appendChild(rowDiv);
    }

    // =============== GATHER FILE NAMES (for multiple images) ===============
    function gatherFileNames(fileInput) {
      if (!fileInput) {
        return [];
      }
      const files = fileInput.files || [];
      let fileNamesArray = [];
      for (let i = 0; i < files.length; i++) {
        fileNamesArray.push(files[i].name);
      }
      return fileNamesArray;
    }

    // =============== SAVE LOCALLY ===============
    function saveLocally() {
      const officeValue = officeSelect.value;
      const countyValue = countySelect.value;
      const employeeNameValue = employeeNameInput.value;
      const dateValue = paymentDateInput.value.trim();
      const defName = defendantNameInput.value.trim();

      let totalCash = 0;
      let totalCheck = 0;
      let totalMoneyOrder = 0;
      let totalCreditCard = 0;

      // 1) First payment row
      const firstType = firstPaymentTypeSelect.value;
      const firstAmt = parseCurrencyString(firstPaymentAmountInput.value);
      switch (firstType) {
        case "Cash":
          totalCash += firstAmt;
          break;
        case "Check":
          totalCheck += firstAmt;
          break;
        case "Money Order":
          totalMoneyOrder += firstAmt;
          break;
        case "Credit Card":
          totalCreditCard += firstAmt;
          break;
      }

      // 2) Additional rows
      const rowDivs = splitRowsContainer.querySelectorAll(".split-row");
      rowDivs.forEach(function(div) {
        const paymentTypeDropdown = div.querySelector("select");
        const selectedType = paymentTypeDropdown.value;
        const amtInput = div.querySelector("input[type='text']");
        const amtVal = parseCurrencyString(amtInput.value);

        switch (selectedType) {
          case "Cash":
            totalCash += amtVal;
            break;
          case "Check":
            totalCheck += amtVal;
            break;
          case "Money Order":
            totalMoneyOrder += amtVal;
            break;
          case "Credit Card":
            totalCreditCard += amtVal;
            break;
        }
      });

      // Partial Payment
      let partialPaymentActive = false;
      let partialPaymentAmt = 0;
      if (partialPaymentSwitch.checked) {
        partialPaymentActive = true;
        partialPaymentAmt = parseCurrencyString(partialPaymentInput.value);
      }

      const actualAmtDue = partialPaymentActive
        ? partialPaymentAmt
        : (totalCash + totalCheck + totalMoneyOrder + totalCreditCard);

      // Gather file names
      const fileNames = gatherFileNames(receiptUpload);

      // Build data object
      const paymentData = {
        office: officeValue,
        county: countyValue,
        employeeName: employeeNameValue,
        date: dateValue,
        defendantName: defName,
        cash: totalCash,
        check: totalCheck,
        moneyOrder: totalMoneyOrder,
        creditCard: totalCreditCard,
        partialPayment: partialPaymentActive,
        partialPaymentAmount: partialPaymentAmt,
        actualAmtDue: actualAmtDue,
        receiptFileNames: fileNames,
        timestamp: new Date().toISOString()
      };

      // Save to localStorage
      let dailyPayments = JSON.parse(localStorage.getItem("dailyPayments")) || [];
      dailyPayments.push(paymentData);
      localStorage.setItem("dailyPayments", JSON.stringify(dailyPayments));
    }

    // =============== SEND EMAIL ===============
    function sendEmail() {
      const subject = "A/R Payment Information";

      const officeValue = officeSelect.value;
      const countyValue = countySelect.value;
      const employeeNameVal = employeeNameInput.value;
      const dateVal = paymentDateInput.value.trim();
      const defName = defendantNameInput.value.trim();

      // Gather all payment rows (first + additional)
      let totalPayment = 0;
      let paymentDetails = "";

      // 1) First row
      const firstType = firstPaymentTypeSelect.value;
      const firstAmt = parseCurrencyString(firstPaymentAmountInput.value);
      totalPayment += firstAmt;
      paymentDetails += `Type: ${firstType}, Amount: $${firstAmt.toFixed(2)}\n`;

      // 2) Additional rows
      const rowDivs = splitRowsContainer.querySelectorAll(".split-row");
      rowDivs.forEach(function(div) {
        const sel = div.querySelector("select");
        const amtInput = div.querySelector("input[type='text']");
        const amtVal = parseCurrencyString(amtInput.value);
        totalPayment += amtVal;
        paymentDetails += `Type: ${sel.value}, Amount: $${amtVal.toFixed(2)}\n`;
      });

      // Partial Payment check
      let partialPaymentText = "No";
      let partialPaymentDetail = "";
      if (partialPaymentSwitch.checked) {
        partialPaymentText = "Yes";
        const partialAmt = parseCurrencyString(partialPaymentInput.value);
        partialPaymentDetail = "\nActual Amount Due: $" + partialAmt.toFixed(2);
      }

      // File attachments (names)
      let multipleFileNames = "";
      const files = receiptUpload.files;
      if (files && files.length > 0) {
        multipleFileNames = "\nAttached File Names:";
        for (let i = 0; i < files.length; i++) {
          multipleFileNames += "\n - " + files[i].name;
        }
      }

      const body =
        "Office: " + officeValue +
        "\nCounty: " + countyValue +
        "\nEmployee: " + employeeNameVal +
        "\nDate: " + dateVal +
        "\nDefendant Name: " + defName +
        "\nPartial Payment: " + partialPaymentText +
        partialPaymentDetail +
        "\n\nPayment Details:\n" + paymentDetails +
        "\nTotal Payment (all rows): $" + totalPayment.toFixed(2) +
        multipleFileNames +
        "\n\n(This data is also saved locally.)";

      const mailtoLink =
        "mailto:Lucas.L@bondjamesbondinc.com"
        + "?subject=" + encodeURIComponent(subject)
        + "&body=" + encodeURIComponent(body);

      window.open(mailtoLink, "_blank");
    }

    // =============== SAVE TO PHP (MySQL) EXAMPLE ===============
    function saveToPHP() {
      const officeValue = officeSelect.value;
      const countyValue = countySelect.value;
      const employeeNameVal = employeeNameInput.value;
      const dateVal = paymentDateInput.value.trim();
      const defName = defendantNameInput.value.trim();

      // Sum all rows for one total payment amount
      let totalPayment = 0;

      // 1) First row
      const firstType = firstPaymentTypeSelect.value;
      const firstAmt = parseCurrencyString(firstPaymentAmountInput.value);
      totalPayment += firstAmt;

      // 2) Additional rows
      const rowDivs = splitRowsContainer.querySelectorAll(".split-row");
      rowDivs.forEach(function(div) {
        const amtInput = div.querySelector("input[type='text']");
        totalPayment += parseCurrencyString(amtInput.value);
      });

      // Partial Payment check
      let partialPaymentActive = false;
      let partialPaymentAmt = null;
      if (partialPaymentSwitch.checked) {
        partialPaymentActive = true;
        partialPaymentAmt = parseCurrencyString(partialPaymentInput.value);
      }

      // Gather file names
      const fileNames = gatherFileNames(receiptUpload);

      // Example data object
      const arPaymentData = {
        office: officeValue,
        county: countyValue,
        employeeName: employeeNameVal,
        date: dateVal,
        defendantName: defName,
        // If you want the specific "types" for each row, you'd store them in a sub-array.
        // For brevity, here we just store totalPayment.
        totalPayment: totalPayment,
        partialPayment: partialPaymentActive,
        partialPaymentAmount: partialPaymentAmt,
        receiptFileNames: fileNames
      };

      // Post to your PHP endpoint
      fetch("save_payment.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(arPaymentData)
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          console.log("Payment saved in MySQL! Payment ID: " + result.paymentId);
        } else {
          alert("Error saving payment: " + result.error);
        }
      })
      .catch(error => {
        console.error("Fetch error:", error);
        alert("Fetch error: " + error.message);
      });
    }

    // =============== EXPORT to XLS (HTML-based) ===============
    function exportCustomXLS(dateVal, agentName, officeName) {
      const stored = localStorage.getItem("dailyPayments");
      if (!stored) {
        alert("No daily payments found in localStorage.");
        return;
      }
      const dailyPayments = JSON.parse(stored);
      if (dailyPayments.length === 0) {
        alert("No daily payment records to export.");
        return;
      }

      let totalCash = 0, totalCheck = 0, totalMO = 0, totalCC = 0;
      const now = new Date();
      let mm = String(now.getMonth() + 1).padStart(2, "0");
      let dd = String(now.getDate()).padStart(2, "0");
      let yyyy = now.getFullYear();

      const countyForFileName = dailyPayments[0].county || officeName;
      const fileName = `${mm}-${dd}-${yyyy}-DailyPaymentLog-${agentName}-${countyForFileName}.xls`;

      let htmlContent = `
        <h1 style="text-align:center;">Daily Payment Log</h1>
        <table border="1" cellspacing="0" cellpadding="4" style="border-collapse:collapse; text-align:center;">
          <!-- Date Row -->
          <tr>
            <td><strong>Date:</strong></td>
            <td>${dateVal}</td>
          </tr>
          <!-- Row 1: Agent Name -->
          <tr>
            <td><strong>Agent Name:</strong></td>
            <td>${agentName}</td>
          </tr>
          <!-- Row 2: Office -->
          <tr>
            <td><strong>Office:</strong></td>
            <td>${officeName}</td>
          </tr>
          <!-- Empty row -->
          <tr><td colspan="9" style="height:10px;"></td></tr>
          <!-- Headers -->
          <tr style="background-color:#f2f2f2;">
            <th>Date</th>
            <th>Defendant Name</th>
            <th>County</th>
            <th>Cash</th>
            <th>Check</th>
            <th>Money Order</th>
            <th>Credit Card</th>
            <th>Partial Pmt (Y/N)</th>
            <th>Actual Amt Due</th>
          </tr>
      `;

      // Rows
      dailyPayments.forEach(payment => {
        totalCash += payment.cash || 0;
        totalCheck += payment.check || 0;
        totalMO += payment.moneyOrder || 0;
        totalCC += payment.creditCard || 0;
        const partialYesNo = payment.partialPayment ? "Y" : "N";
        const actualDue = payment.actualAmtDue || 0;

        htmlContent += `
          <tr>
            <td>${payment.date || ""}</td>
            <td>${payment.defendantName || ""}</td>
            <td>${payment.county || ""}</td>
            <td>${(payment.cash || 0).toFixed(2)}</td>
            <td>${(payment.check || 0).toFixed(2)}</td>
            <td>${(payment.moneyOrder || 0).toFixed(2)}</td>
            <td>${(payment.creditCard || 0).toFixed(2)}</td>
            <td>${partialYesNo}</td>
            <td>${actualDue.toFixed(2)}</td>
          </tr>
        `;
      });

      // Totals
      htmlContent += `
          <tr><td colspan="9" style="height:10px;"></td></tr>
          <tr style="background-color:#eee;">
            <td></td>
            <td><strong>Totals</strong></td>
            <td></td>
            <td><strong>${totalCash.toFixed(2)}</strong></td>
            <td><strong>${totalCheck.toFixed(2)}</strong></td>
            <td><strong>${totalMO.toFixed(2)}</strong></td>
            <td><strong>${totalCC.toFixed(2)}</strong></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td></td>
            <td><strong>Amount to be deposited</strong></td>
            <td></td>
            <td><strong>${totalCash.toFixed(2)}</strong></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
          </tr>
        </table>
      `;

      // Create a Blob for the XLS
      const blob = new Blob([htmlContent], {
        type: "application/vnd.ms-excel;charset=utf-8"
      });

      // Trigger download
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    // =============== EXPORT to XLSX (SheetJS) ===============
    function exportDailyLogXlsx(dateValue, agentName, officeName, dailyPayments) {
      // Build an array-of-arrays for each row
      const rows = [];
      rows.push(["Daily Payment Log"]); // Title row
      rows.push(["Date:", dateValue]);
      rows.push(["Agent Name:", agentName]);
      rows.push(["Office:", officeName]);
      rows.push([]); // blank row
      rows.push([
        "Date",
        "Defendant Name",
        "County",
        "Cash",
        "Check",
        "Money Order",
        "Credit Card",
        "Partial Pmt (Y/N)",
        "Actual Amt Due"
      ]);

      let totalCash = 0, totalCheck = 0, totalMO = 0, totalCC = 0;

      dailyPayments.forEach(payment => {
        const dateVal = payment.date || "";
        const defName = payment.defendantName || "";
        const county = payment.county || "";
        const cash = payment.cash || 0;
        const check = payment.check || 0;
        const mo = payment.moneyOrder || 0;
        const cc = payment.creditCard || 0;
        const partialYesNo = payment.partialPayment ? "Y" : "N";
        const actualDue = payment.actualAmtDue || 0;

        rows.push([
          dateVal,
          defName,
          county,
          cash,
          check,
          mo,
          cc,
          partialYesNo,
          actualDue
        ]);

        totalCash += cash;
        totalCheck += check;
        totalMO += mo;
        totalCC += cc;
      });

      rows.push([]);
      rows.push(["", "Totals", "", totalCash, totalCheck, totalMO, totalCC, "", ""]);
      rows.push(["", "Amount to be deposited", "", totalCash, "", "", "", "", ""]);

      // Convert rows => worksheet
      const ws = XLSX.utils.aoa_to_sheet(rows);

      // Optionally add merges or styling
      ws["!merges"] = [
        { s: {r:0, c:0}, e: {r:0, c:8} } // Merge top title (A1..I1)
      ];
      // Style the "A1" cell for bold + centered
      if (ws["A1"]) {
        ws["A1"].s = {
          alignment: { horizontal: "center" },
          font: { bold: true, sz: 16 }
        };
      }

      // Basic border & center alignment from row 6 onward
      const startRowIndex = 5; // zero-based index
      for (let R = startRowIndex; R < rows.length; R++) {
        for (let C = 0; C < 9; C++) {
          const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
          if (!ws[cellRef]) continue;
          if (!ws[cellRef].s) ws[cellRef].s = {};
          ws[cellRef].s.alignment = { horizontal: "center" };
          ws[cellRef].s.border = {
            top:    { style: "thin", color: { rgb: "000000" } },
            right:  { style: "thin", color: { rgb: "000000" } },
            bottom: { style: "thin", color: { rgb: "000000" } },
            left:   { style: "thin", color: { rgb: "000000" } }
          };
        }
      }

      // Create workbook
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Daily Payment Log");

      // Filename
      const safeDate = (dateValue || "NoDate").replace(/\//g, "-");
      const fileName = `${safeDate}-DailyPaymentLog-${agentName}-${officeName}.xlsx`;

      XLSX.writeFile(wb, fileName);
    }

    // =============== EXPORT to CSV (Placeholder) ===============
    function exportToCSV() {
      alert("CSV export function is not fully implemented. (Placeholder)");
    }

    // =============== BUTTON HANDLERS ===============
    saveBtn.addEventListener("click", function() {
      saveLocally();
      saveToPHP();
      // Then export to XLS automatically
      const dateVal = paymentDateInput.value.trim() || "NoDate";
      const agent = employeeNameInput.value;
      const officeName = officeSelect.value;
      exportCustomXLS(dateVal, agent, officeName);

      alert("Saved locally + MySQL + exported to XLS!");
    });

    saveAndSendBtn.addEventListener("click", function() {
      saveLocally();
      saveToPHP();
      // Export to XLS if desired
      const dateVal = paymentDateInput.value.trim() || "NoDate";
      const agent = employeeNameInput.value;
      const officeName = officeSelect.value;
      exportCustomXLS(dateVal, agent, officeName);

      // Then send email
      sendEmail();
      alert("Saved locally + MySQL + XLS + Email triggered!");
    });

    exportBtn.addEventListener("click", function() {
      exportToCSV();
    });

    saveToPhpBtn.addEventListener("click", function() {
      saveToPHP();
    });

    exportXlsBtn.addEventListener("click", function() {
      const dateVal = paymentDateInput.value.trim() || "NoDate";
      const agent = employeeNameInput.value;
      const officeName = officeSelect.value;
      exportCustomXLS(dateVal, agent, officeName);
    });

    exportXlsxBtn.addEventListener("click", function() {
      const stored = localStorage.getItem("dailyPayments");
      if (!stored) {
        alert("No daily payments in localStorage.");
        return;
      }
      const dailyPayments = JSON.parse(stored);
      if (dailyPayments.length === 0) {
        alert("No daily payment records to export.");
        return;
      }
      const dateVal = paymentDateInput.value.trim() || "NoDate";
      const agent = employeeNameInput.value;
      const officeName = officeSelect.value;
      exportDailyLogXlsx(dateVal, agent, officeName, dailyPayments);
    });
  </script>
</body>
</html>
